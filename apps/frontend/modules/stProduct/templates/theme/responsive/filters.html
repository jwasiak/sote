{assign var=filter_only value="available_only"}

{strip}
    {capture name="filters"}
        <form class="product-filters" action="{urlfor internal=$action_url}" method="post">
            {if $show_available_only_filter}
                <input type="hidden" name="fields" value="available_only">
                <div class="form-group available-only-filter">
                    <div class="checkbox">
                        <label>
                            <input name="product_filter[available_only]" type="checkbox" value="1" {if isset($filters[$filter_only])} checked{/if}> {__ text="Pokaż produkty dostępne"}
                        </label>
                    </div>
                </div>
                {literal}
                    <script>
                        jQuery(function($) {
                            $('.available-only-filter').change(function() {
                                $(this).closest('form').submit();
                            }); 
                        });
                    </script>
                {/literal}
            {/if}
        </form>
        {st_get_component module="stProduct" component="priceFilter" criteria=$criteria}
        {st_get_component module="appProductAttributeFrontend" component="showFilter" criteria=$criteria}
        {st_get_component module="stProductOptionsFrontend" component="filter" criteria=$criteria}
    {/capture}
{/strip}

{if !$sf_request->isXmlHttpRequest()}
    {if !$modal_only}
        {strip}
        <div class="product-filter-container">
            {$smarty.capture.filters}
        </div>
        {/strip}
    {/if}
    <div id="product-filter-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close show-products" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">{__ text="Filtr produktów"}</h4>
            </div>
            {strip}
            <div class="modal-body">
                {strip}
                    <div class="product-filter-container">
                        {$smarty.capture.filters}
                    </div>
                {/strip}
            </div>
            {/strip}
                <div class="modal-footer">
                    {if $has_filters}
                        <a class="btn btn-default" href="{urlfor internal='@stProduct?action=clearFilter'}" rel="nofollow">{__ text="Wyczyść"}</a>
                    {/if}
                    <a class="btn btn-primary show-products" href="#">{__ text="Pokaż produkty"}</a>
                </div>        
        </div>
      </div>
    </div>
    {literal}
    <script type="text/javascript">
        jQuery(function($) {
            var producer_filter = $('#producer-filter'); 
            {/literal}
            {if $modal_only}
                $('#btn-product-filter').attr("style", "display: inline-block !important");
            {else}
                producer_filter.removeClass('hidden');
            {/if}
            {literal}

            function showPreloader() {
                preloader($(this).closest('.product-filter-container'));
            }

            function preloader(selector) {
                selector.prepend('<div class="preloader"><div>');
            }

            $('#btn-product-filter').removeClass('hidden-xs hidden-sm');
            $('#product-filter-modal').appendTo('body');

            $('.product-filter-container')
                .on('submit', 'form', showPreloader)
                .on('click', '.reset', showPreloader);

            var modal = $('#product-filter-modal');
            var container = modal.find('.product-filter-container');

            if (producer_filter.html()) {
                container.prepend(producer_filter.html());
            }


            if (container.is(':empty') ) {
                $('#btn-product-filter').removeAttr('style').hide();
            }

            container.on('change', 'select.producer-select', function() {
                $(this).closest('form').submit();
            });

            container.on('submit', 'form', function() {
                var form = $(this);

                $.post(form.attr('action'), form.serialize(), function(data) {
                    container.html(data);
                });

                return false;
            });

            container.on('click', '.reset', function() {
                var btn = $(this);

                $.get(btn.attr('href'), function(data) {
                    container.html(data);
                });                

                return false;
            });

            modal.on('click', '.show-products', function() {
                preloader(container);
                if (window.location.href.indexOf('filter=1') !== -1) {
                    window.location.reload();
                } else {
                    var sep = window.location.href.indexOf('?') !== -1 ? '&' : '?';
                    window.location.assign(window.location.href+sep+'filter=1');
                }
                return false;
            });
        });
    </script>  
    {/literal} 

{else}
    {st_get_component module="stProduct" component="producerFilter" criteria=$criteria}
    {$smarty.capture.filters}
{/if}
